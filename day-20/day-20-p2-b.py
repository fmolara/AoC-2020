#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Advent Of Code 2020
# Day 20 / Part 2-B
#
# (c) 2020-2023 Federico Molara <federico@molara.net>
# This code is licensed under MIT license (see LICENSE.txt for details)

import itertools
import operator
import numpy, math



def IterateLines():
    if 0:
        str = """.#.#..#.##...#.##..#####
###....#.#....#..#......
##.##.###.#.#..######...
###.#####...#.#####.#..#
##.#....#.##.####...#.##
...########.#....#####.#
....#..#...##..#.#.###..
.####...#..#.....#......
#..#.##..#..###.#.##....
#.####..#.####.#.#.###..
###.#.#...#.######.#..##
#.####....##..########.#
##..##.#...#...#.#.#.#..
...#..#..#.#.##..###.###
.#.#....#.##.#...###.##.
###.#...#..#.##.######..
.#.#.###.##.##.#..#.##..
.####.###.#...###.#..#.#
..#.#..#..#.#.#.####.###
#..####...#.#.#.###.###.
#####..#####...###....##
#.##..#..#...#..####...#
.#.###..##..##..####.##.
...###...##...#...#..###"""
    else:
        str = """.....#...............#.....#...............#.#.....#...........##.#......##..#..#......#..##..##
...........###........##...............##...#..........###..##....#..##.##...#........#..#.#...#
#.........#...###........#.#..#.#...#..#.#...##.#.......#.................#......#........#.....
....#.....#...#.........#..#..#........#...##..#..#..#..#..#...#...##....#.............##.##....
.#.#........##......#........##..........###....###.#.#####.##.....#..#.....#.#.#.....#....#....
.......#.##....#........#........#.....#..##.#...................##...##.#....##...#.....#.#.##.
.........#...#.#..#..#..#..##.#..#.##....#..#..#...#.#.......#...##........#.#........#....#....
.#...#..#.#.#.###.###....##....###..##...#.......#..#..#.##.##.###..##.###.#.##..##.#.##...#....
....##....#....##..#......#....#......#.......####...##.#..###...##..####.#####...##....##......
..........#.........#.........#.#.###....##....##.###..#............###....#.#......#..#.......#
#....###...#......#..##.#.#.#........#...#.##..#..#.........#..###.#.###.....#...###..#........#
..#...................#...#........##......##..#.#.#.........#..#.#...#...#..#.#.....#.#.....#..
.#.#.....#.....##...##.....###..........####.....#...#...##.#.###.#..####...#.#.....#....###....
...###.#####..#..#.##.##.#............#.##..#..#.#....####...###..###....#...#.....#............
###..###....###...###.#.#.#....##..#....#............#.##...#...##.........#....##........#.....
#.#...#...#.#..#........###.#.#.#....#........##.......#.....#...........#.........#.#..#.......
.##.......#........#...#.##......#...#......#....#..#.....##..#.....##...........#...#..#...##..
...##.##..#..#..#....#..#.....#......##.#...#.#..##.....#....#.....#........#..#...#..#.#..#....
..........#.#.##..#...##....#....##.#..#...#.#..#..#..#.###.#..#...............####..#......#...
#.........##.#......#..........##.#.......###....##....##...##......#.#......#....##....#.......
....#...#.....###.#.#...#.#..#........#....#...##...#.#..#.....#.....#.#.......##........#......
#...#.#.#..#..#.##.##..#.##.#....##......##.#...#...#.#.#..##.............#....##...##....###...
....##.####....##....###...##...........#...#..#.#....#............#..#.#...#...#...#....#......
....#.#..##..................#..#........##..#....##.#....##.........#...#...#.....#.###.......#
.#......##....#.......#........#...#.#...#.......#...............##..#.##.#..#.##.#....#.##.##..
#.#..##.....##...#..#.#..#....#.........##.#....#......#....#.............#..#.............##.#.
.#..#.#...#......##...#...#.##............#...#....##.#...#....#...#.......#......#.####.##..#..
#..##...#...#....#...##....#.##.#..#.#.#.#.##..#......#...#..#..#.##..##.#....#.........#....#..
.##.....#......#..#..#..#..#..#.........#............#####..#.##....##...##................##...
.......#...####....##....##....#.........####..#..#....##.....##...#...#.....#....#..#.#........
#....####....#..#.#..#.#....#.#....#..##....#...........##.....##..##.#.####...#.....#.....#...#
....#.##..#.##.......#..#..#...#.#.........#..........#....#.........#...#..............#..#....
...............###...#......##..#..#...............#.###...........#...#.#........##..###.......
.......#.#.##.....#...#.#...............#.....#.........#..#........#...#.##.##.....#.##...#....
.........#...#..........##..............#.###..#..#..#.###.###..#..#............#........#......
..##.......#......#.##.....#............#####...##....##....#..........##..#...#..#.#..#.#......
.....##..#.#.##.#.#.....#.#...........#...#..#...#............#..#..#....#....#.....#....##.....
.#.#.#.........#.................#.##.#.#..##.##........###.....##..#..#....#.....#...#.#..#...#
#...#.....#.#....#.#.....#....#.#...............#.......##...#...##..#...#...#...##.....#..#....
#..##.##....##.........#...#.##..#..#...##.#........#..##.##.##.#..#..##.....#..#..##....#...##.
..#..#..#....##.#.#....##.##.#..#..#..#..##.........####...##....##....#..###..#.......##.#....#
...........#.....#.#.#.###....##..#.###.#.#...#...#..#.#.........#....#...........###....#......
.##.......##.##..#......#.##.#.......#.#.......##..#...........####.##.........#.#.#.#....#..#..
.#...#.#.#...###.###.......#............#....#...##..#.......#.#.##.#...#.................#.....
.........#.........#...#.#...#....#............##..#.##...#.##..#..#..#.##......#...#...#.......
...#..#...##.#..#.....#.#.....#...........#...#....#...###....##....##..#.#..####....#......#...
......#....##.#.#.#.#....###..#.##..#..#..#......#......##....#..........#..#.#.###......#....#.
.......##....##.#....##.####...##..####....##.......#.............##...##..#...##....#.##.#..##.
.....#...#........#.#.#..##..........##.......#...##.................###.##.#..#.##..#.#..#.#...
.........#...........#......#......#...#..####.....#..#...#....#.#####..#####..####...#....#..##
.................###....#.#..#..#..#........#...#...........##..#.#.#.............#.....#..#...#
...#.#...#..#..#######.###.#...####.##..#..##.#.##.......#.#.#..#...##..##...#.#..#.#.#......#.#
.#.#..###.#.###....##....#.....###.#..##..#.##....###........#..................#...............
...##..##....................#..#..#.......#.........###...#.#....##........#...........#.......
.....##..#....##.#.............###..#.#.....#........#..#........##.#..#..#..#.##.##.......#....
.....#.#...#..#...###.##.#.......#.#.##.#..##.####.###.#......###....####..##....##..#.#........
.##..#.#.##..##......#....#.#.....#..###....###...###...##.#...#..###.#.#..##..#.#..............
............#..#........#.....#..##...#.#...#.........##.....#..#....##....#....##...#...####...
#...###...#...........#.....#..#.......#..#.#.....#......#......#.........#.#.......#...#.#.....
#..#.......##.......#....#.....#..#..#...............#.......##...#..#.............#....##......
#.###......#.#...##.....#..##.#.##...#.#...#..........#.#..##.#..#..#..#..##.#.....#....#..#..#.
.##.#.##..#...#....####.....#.#.#..##.........#.#.#..###....##..#.##..###...#......##..#........
.....#.......#......#####........#...###..........#...#....#....#..#....#.#......#............#.
.........##..#...#.#....#......#..#..##.#.##..###......###..#....#..##.....#.......#.##.......#.
..#.#.##..#...#...###.....#####....##....##...##.....#.#.....................##...#.....#.#.#...
......#......#..........#....#..#.#.###...#..#.##.#.#...###....##.....................#..#..#...
#............#....#..#............##...#.##.....#...#...#..........##.....#..#..#..##.#.#####...
...#..#.......#.........#..#...........#....#.#..##.##.#.##..#....##..#...###....##....##....#..
.#............#.#.....#.#.......#...#......#####..##.#..###...#..#.#...#...#.#####.#.....#..#...
.#..###.......#...............#..........#.##.....#.....#..#...............##...#...#.#...#.....
..#.#..#...#..###..#......#.#....#....#.##.#...#...........#..#.........#.....##...#.....#.##...
#.#.....#....##.....#..#....#........................#........##....#.........................#.
....#.#..........#.#......#.....#..#.......#......#...#.##..........##...#...#...#.........##.#.
..#.........##.#.....##..#.#....#.##......#.#.#.#.##..##.#..#..#..#.....#.#####..#..#.##........
.#.......##...#.#..#.#####..#..#..##.#...###.###....##....##....#.#..###....###...##....##......
...##..........####...###....##..#.#...#....#.#.............#....#...##............#..#.......#.
#.....#..........##....#..#........##.#.....#.###..##....#.......#...###..#...................##
..........##................#.##.####..#.#..#...#......#.###.#.....#..#.......##...............#
#.#...###...........####....#..#..#..#........#...#.#.#.........#.#.......###...#..#.#.....#...#
.#....#...###..#.#.....#.......#..#........##........#....#.#......#......##.....#.........#...#
#....##.....##.....##.#..#..#....##.#...##.......#.#..#....#.#.........#.......#..#......#.#....
..........#..#..#..#####.#.....#.####..#............##.#..#...........#.....#...#..#..#...#..##.
......####....##...####...#.....#.....#....##..#..#..#..#..##....#.#..##....##.............##...
....#..##...#............#.....#...###.#.###....##..#.##.##.##..#..#......##.##...#..###...#..#.
..#......#.#....#.#....#...........###....#...#...#.........#.........##..................#..#.#
.....##.#...#.#....#..#.......#...###...###....#....##.......#...##...#..#.##..#..#..#.......#.#
.......##............#...#.....#....####...###......#....#.......#.###....###...##....#........#
........#...##.#.#....#..##.#........###..#.......#.....#......#.#..##..#......##....##..#......
.....#..###.................#..#..#..#..#..#.....##.#.#.#.#.#.#.#.....#.............#...........
.....##....#...##.##.....###....##.#..###.###..................#.#....#....##.#..#..#..#..###..#
....#.#..........#..#..##.#......#.....#........##...##...#...#........######..##....##.#.##....
.#..##.#.#....#....##.......#.##.#..#..#.#.......#.........#.##.....#....#...#....#.#.......###.
..#....#......#.........#.#...#.#...#...##...#..#..#..#..##.#..##.###.##...#...#..####.#.###..##
........#....#..##...#....#..#...........####....###...##..#.##.#.....#..#.....#..#.#....#.#..#.
..#.#.##.........#.....#..#...#.#......#...#...........#.#..##....#...##...#.....#...#....##.##.
.##.#..##.....#......#.#..#..##.#.#...#.....#.............#........#..#.#......#..#.........##.."""
    for line in str.splitlines():
        yield line


def GetImage():
    img = None
    for line in IterateLines():
        if img is None:
            img = numpy.array( [[c] for c in line] )
        else:
            img = numpy.append( img, [[c] for c in line], axis=1 )
    return img


def GetTile( img, rot, x_flip, y_flip ):
    assert 0 <= rot < 4

    if y_flip:   img = numpy.flip( img, axis = 0 )
    if x_flip:   img = numpy.flip( img, axis = 1 )
    if rot > 0:  img = numpy.rot90( img, k = rot )

    return img


def PrintImage( img ):
    for y in range(img.shape[1]):
        line = ''.join( [img[x, y] for x in range(img.shape[0])] )
        print( line )


def CountImage( img, c ):
    return sum( sum( 1 if img[x, y] == c else 0  for x in range(img.shape[0]) )  for y in range(img.shape[1]) )


def MatchImage( img, pattern, x, y ):
    for ix in range(pattern.shape[0]):
        for iy in range(pattern.shape[1]):
            if pattern[ix, iy] == '#'  and  img[x+ix, y+iy] not in ('#', 'O'):
                return False
    return True


def FindPattern( img, pattern ):
    for x in range(img.shape[0]-pattern.shape[0]):
        for y in range(img.shape[1]-pattern.shape[1]):
            if MatchImage( img, pattern, x, y ):
                yield x, y


def FixPattern( img, pattern, x, y ):
    for ix in range(pattern.shape[0]):
        for iy in range(pattern.shape[1]):
            if pattern[ix, iy] == '#':
                assert img[x+ix, y+iy] in ('#', 'O')
                img[x+ix, y+iy] = 'O'


img = GetImage()
#PrintImage( img )

pattern = numpy.array(           [[c] for c in "                  # "] )
pattern = numpy.append( pattern, [[c] for c in "#    ##    ##    ###"], axis=1 )
pattern = numpy.append( pattern, [[c] for c in " #  #  #  #  #  #   "], axis=1 )
#PrintImage( pattern )

fixed_img = None
for rot in range(4):
    for x_flip in (False, True):
        for y_flip in (False, True):
            found = False
            tile = GetTile( img, rot, x_flip, y_flip )
            for x, y in FindPattern( tile, pattern ):
                print( rot, x_flip, y_flip, (x, y) )
                FixPattern( tile, pattern, x, y )
                found = True
            if found:
                fixed_img = tile
                break
        else:
            continue
        break
    else:
        continue
    break
else:
    print( "-- not found --")

if fixed_img is not None:
    PrintImage( fixed_img )
    print( CountImage( fixed_img, '#' ) )

# right -> 2006
